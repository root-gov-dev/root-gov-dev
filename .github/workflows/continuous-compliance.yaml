name: continuous-compliance-automation
on:
  push:
    branches: [ main ]
  pull_request:
    paths:
      - 'manifests/**'
      - 'skills/compliance-automation/**'
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ™‚è‡ªå‹•æŽƒæ

jobs:
  intelligent-scan-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install pyyaml
    
    - name: Run Intelligent Compliance Scanner
      run: |
        python skills/compliance-automation/intelligent-scanner.py
    
    - name: Upload Compliance Report
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance-report.json
    
    - name: Auto-Commit Fixes
      if: github.event_name == 'pull_request' || github.event_name == 'push'
      run: |
        if git diff --quiet; then
          echo "æ²’æœ‰éœ€è¦æäº¤çš„ä¿®å¾©"
        else
          git config --local user.email "compliance-bot@example.com"
          git config --local user.name "Compliance Automation Bot"
          git add .
          git commit -m "ðŸ¤– è‡ªå‹•åˆè¦ä¿®å¾©: é¡åƒæ›¿æ›èˆ‡å®‰å…¨å¼·åŒ–"
          git push
        fi
    
    - name: Create PR for Manual Fixes
      if: always() && github.event_name == 'schedule'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ðŸ¤– å®šæœŸåˆè¦ä¿®å¾©"
        title: "è‡ªå‹•åˆè¦ä¿®å¾©èˆ‡å„ªåŒ–"
        body: |
          æœ¬æ¬¡è‡ªå‹•åˆè¦æŽƒæç™¼ç¾ä»¥ä¸‹éœ€è¦æ‰‹å‹•è™•ç†çš„å•é¡Œï¼š
          
          - é«˜é¢¨éšªé¡åƒæ›¿æ›
          - å®‰å…¨ä¸Šä¸‹æ–‡å¼·åŒ–  
          - å‘½åç©ºé–“æ¨™ç±¤è£œå…¨
          
          è«‹å¯©æ ¸ä¸¦åˆä½µæ­¤PRä»¥æå‡æ•´é«”åˆè¦æ°´å¹³ã€‚
        branch: auto-compliance-fixes
        base: main

  policy-telemetry:
    runs-on: ubuntu-latest
    needs: intelligent-scan-and-fix
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Compliance Report
      uses: actions/download-artifact@v4
      with:
        name: compliance-report
    
    - name: Generate Policy Metrics
      run: |
        echo "æ­£åœ¨ç”Ÿæˆç­–ç•¥é™æ¸¬æ•¸æ“š..."
        # é€™è£¡å¯ä»¥é›†æˆåˆ°Prometheusæˆ–å…¶ä»–ç›£æŽ§ç³»çµ±
        echo "policy_compliance_score $(jq '.compliance_score' compliance-report.json)" > metrics.txt
        echo "policy_violations_total $(jq '.violations_found' compliance-report.json)" >> metrics.txt
        echo "policy_auto_fixes_applied $(jq '.auto_fixes_applied' compliance-report.json)" >> metrics.txt
    
    - name: Upload Metrics
      uses: actions/upload-artifact@v4
      with:
        name: policy-metrics
        path: metrics.txt