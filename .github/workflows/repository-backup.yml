name: Automated Repository Backup

on:
  # Run weekly on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      repositories:
        description: 'Comma-separated list of repositories to backup (leave empty for all)'
        required: false
        default: ''

jobs:
  backup:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        repository:
          - root-gov-dev
          - ops-core-root-system
          - app
      fail-fast: false
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          path: main-repo
      
      - name: Set up environment
        run: |
          echo "BACKUP_DATE=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
          echo "REPO_NAME=${{ matrix.repository }}" >> $GITHUB_ENV
      
      - name: Clone repository for backup
        continue-on-error: true
        run: |
          # Clone with full history and all branches
          git clone --mirror https://github.com/root-gov-dev/${{ matrix.repository }}.git backup-${{ matrix.repository }}
        
      - name: Create bundle backup
        if: success()
        run: |
          cd backup-${{ matrix.repository }}
          git bundle create ../${{ matrix.repository }}.bundle --all
          cd ..
      
      - name: Generate backup metadata
        if: success()
        run: |
          cat > backup-metadata.json << EOF
          {
            "repository": "${{ matrix.repository }}",
            "organization": "root-gov-dev",
            "backup_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_count": $(cd backup-${{ matrix.repository }} && git rev-list --all --count),
            "branches": $(cd backup-${{ matrix.repository }} && git branch -r | wc -l),
            "size_bytes": $(stat -f%z ${{ matrix.repository }}.bundle 2>/dev/null || stat -c%s ${{ matrix.repository }}.bundle)
          }
          EOF
      
      - name: Upload backup artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ matrix.repository }}-${{ env.BACKUP_DATE }}
          path: |
            ${{ matrix.repository }}.bundle
            backup-metadata.json
          retention-days: 90
          compression-level: 9
      
      - name: Create backup summary
        if: success()
        run: |
          echo "### âœ… Backup Successful: ${{ matrix.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Bundle Size**: $(ls -lh ${{ matrix.repository }}.bundle | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits**: $(cd backup-${{ matrix.repository }} && git rev-list --all --count)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branches**: $(cd backup-${{ matrix.repository }} && git branch -r | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention**: 90 days" >> $GITHUB_STEP_SUMMARY
      
      - name: Report failure
        if: failure()
        run: |
          echo "### âŒ Backup Failed: ${{ matrix.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Repository may not exist or is not accessible." >> $GITHUB_STEP_SUMMARY
  
  summary:
    runs-on: ubuntu-latest
    needs: backup
    if: always()
    
    steps:
      - name: Create summary report
        run: |
          echo "## ðŸ“¦ Repository Backup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backup Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All repository backups have been processed." >> $GITHUB_STEP_SUMMARY
          echo "Check individual job outputs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recovery Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To restore from a backup:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the bundle file" >> $GITHUB_STEP_SUMMARY
          echo "3. Run: \`git clone <repo-name>.bundle <directory>\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Push to GitHub: \`git remote set-url origin <github-url> && git push --mirror\`" >> $GITHUB_STEP_SUMMARY
